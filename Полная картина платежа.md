## **1. Frontend (–ë—Ä–∞—É–∑–µ—Ä, Apple Pay JS)**

### **üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Frontend?**

1. **–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–Ω–æ–ø–∫—É Apple Pay**
    
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ Apple Pay (`ApplePaySession.canMakePayments()`).
    - –ï—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, **–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É** "–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Apple Pay".
2. **–°–æ–∑–¥–∞—ë—Ç Apple Pay Session** (`ApplePaySession`)
    
    - –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `ApplePaySession`.
    - Apple –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `validationURL` (–Ω—É–∂–Ω–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞).
    - Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç `validationURL` –Ω–∞ Backend.
3. **–ü–æ–ª—É—á–∞–µ—Ç `merchantSession` –æ—Ç Backend**
    
    - Backend –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `validationURL`, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π `Merchant Identity Certificate`.
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `merchantSession`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `ApplePaySession.completeMerchantValidation()`.
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É (Face ID / Touch ID)**
    
    - Apple Pay –≤—ã–¥–∞—ë—Ç **`paymentData`** ‚Äì –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∫–∞—Ä—Ç—ã.
5. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `paymentData` –Ω–∞ Backend**
    
    - Frontend –¥–µ–ª–∞–µ—Ç `POST /applepay/process-payment`, –ø–µ—Ä–µ–¥–∞—ë—Ç `paymentData`.

---

## **üîπ 2. Backend (Golang, API –∫ Stripe)**

### **üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Backend?**

1. **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç `paymentData` –æ—Ç Frontend**
    
    - –ü–∞—Ä—Å–∏—Ç JSON –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (`paymentData`).
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –≤ Stripe API.
2. **–°–æ–∑–¥–∞—ë—Ç `PaymentMethod` –≤ Stripe** (`POST /v1/payment_methods`)
    
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `paymentData` –≤ Stripe.
    - Stripe **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç** –¥–∞–Ω–Ω—ã–µ Apple Pay –∏ —Å–æ–∑–¥–∞—ë—Ç `PaymentMethod`.
    - Stripe –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **`payment_method_id`**.
3. **–°–æ–∑–¥–∞—ë—Ç `PaymentIntent` –≤ Stripe** (`POST /v1/payment_intents`)
    
    - –ü–µ—Ä–µ–¥–∞—ë—Ç **`payment_method_id`**, —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—É.
    - –ï—Å–ª–∏ `confirm: true`, Stripe —Å—Ä–∞–∑—É —Å–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–Ω—å–≥–∏.
    - –ï—Å–ª–∏ `confirm: false`, –ø–ª–∞—Ç—ë–∂ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
4. **–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Stripe**
    
    - –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `status: succeeded`.
    - –ï—Å–ª–∏ –Ω—É–∂–µ–Ω 3D Secure –∏–ª–∏ OTP, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `requires_action`.
    - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤, –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `failed`.
5. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ Frontend**
    
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (`succeeded`, `requires_action`, `failed`).

---

## **üîπ 3. Stripe (–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞)**

### **üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Stripe?**

1. **–ü–æ–ª—É—á–∞–µ—Ç `paymentData`**
    
    - –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ Apple Pay).
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, **–≤–∞–ª–∏–¥–Ω—ã –ª–∏ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã**.
2. **–°–æ–∑–¥–∞—ë—Ç `PaymentMethod`**
    
    - –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ **–≤–∞–ª–∏–¥–Ω–∞**, —Å–æ–∑–¥–∞—ë—Ç **`payment_method_id`**.
    - –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ **–Ω–µ–≤–∞–ª–∏–¥–Ω–∞**, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É (`requires_payment_method`).
3. **–°–æ–∑–¥–∞—ë—Ç `PaymentIntent`**
    
    - –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç `payment_method_id`.
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç **—Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—É**.
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –±–∞–Ω–∫.
4. **–ü—Ä–æ–≤–æ–¥–∏—Ç –æ–ø–ª–∞—Ç—É** (–µ—Å–ª–∏ `confirm: true`)
    
    - –ï—Å–ª–∏ –±–∞–Ω–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ ‚Üí `succeeded` ‚úÖ.
    - –ï—Å–ª–∏ –±–∞–Ω–∫ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (OTP, 3D Secure) ‚Üí `requires_action` üîÑ.
    - –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª ‚Üí `failed` ‚ùå.

---

## **üîπ 4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞**

### **üìå –ö–∞–∫ —É–∑–Ω–∞—Ç—å, –ø—Ä–æ—à—ë–ª –ª–∏ –ø–ª–∞—Ç—ë–∂?**

1. **Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å**:

    `GET /v1/payment_intents/{payment_intent_id}`
    
2. **Stripe –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON:**

    `{   "id": "pi_1N2QfK2eZvKYlo2CTnJnJX3L",   "object": "payment_intent",   "status": "succeeded",   "amount": 1000,   "currency": "usd" }`
    
3. **Frontend –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI (–ø–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω / –æ—à–∏–±–∫–∞).**

---

## **üîπ 5. –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–∞**

|–°—Ç–∞—Ç—É—Å|–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç?|
|---|---|
|`succeeded` ‚úÖ|–ü–ª–∞—Ç—ë–∂ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ|
|`requires_action` üîÑ|–¢—Ä–µ–±—É–µ—Ç—Å—è 3D Secure / –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –±–∞–Ω–∫–µ|
|`requires_payment_method` ‚ùå|–û—à–∏–±–∫–∞ (–Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã)|
|`failed` ‚ùå|–ü–ª–∞—Ç—ë–∂ –æ—Ç–∫–ª–æ–Ω—ë–Ω –±–∞–Ω–∫–æ–º|
|`requires_confirmation`|–û–∂–∏–¥–∞–µ—Ç —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è|

---

## **üîπ 6. –ü–æ–ª–Ω—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (Frontend ‚Üí Backend ‚Üí Stripe)**

### **üü¢ 1. Frontend (Apple Pay)**

‚úÖ **–ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Apple Pay"**  
‚úÖ `ApplePaySession` —Å–æ–∑–¥–∞—ë—Ç `validationURL`  
‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `validationURL` –Ω–∞ Backend

### **üü¢ 2. Backend (Golang)**

‚úÖ `POST /applepay/validate-merchant` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç `merchantSession`  
‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `merchantSession` –Ω–∞ Frontend

### **üü¢ 3. Frontend (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞)**

‚úÖ `session.completeMerchantValidation(merchantSession)`  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ (Face ID / Touch ID)  
‚úÖ `onpaymentauthorized` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç `paymentData`  
‚úÖ `POST /applepay/process-payment` ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `paymentData` –Ω–∞ Backend

### **üü¢ 4. Backend (Golang ‚Üí Stripe)**

‚úÖ `POST /v1/payment_methods` ‚Üí –ø–µ—Ä–µ–¥–∞—ë—Ç `paymentData` –≤ Stripe  
‚úÖ `POST /v1/payment_intents` ‚Üí —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂  
‚úÖ Stripe –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç—ë–∂  
‚úÖ Backend –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (`succeeded`, `failed`, `requires_action`)  
‚úÖ Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å Frontend

### **üü¢ 5. Frontend (–†–µ–∑—É–ª—å—Ç–∞—Ç)**

‚úÖ –ü–æ–ª—É—á–∞–µ—Ç `status: succeeded` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞"  
‚úÖ –ò–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç `status: failed` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û—à–∏–±–∫–∞"

---

## **üîπ 7. –í—ã–≤–æ–¥**

1. **Frontend –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–ª–∞—Ç—ë–∂, –ø–æ–ª—É—á–∞–µ—Ç `paymentData`.**
2. **Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `paymentData` –≤ Stripe (—Å–æ–∑–¥–∞—ë—Ç `PaymentMethod`).**
3. **Backend —Å–æ–∑–¥–∞—ë—Ç `PaymentIntent`, Stripe –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç—ë–∂.**
4. **Stripe –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å (`succeeded`, `failed`, `requires_action`).**
5. **Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ Frontend, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.**