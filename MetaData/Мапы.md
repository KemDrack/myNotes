

## –ß—Ç–æ —Ç–∞–∫–æ–µ Map?

Map - —ç—Ç–æ –Ω–µ—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –ø–∞—Ä –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–∞–∫ —Ö–µ—à-—Ç–∞–±–ª–∏—Ü–∞. –í–Ω—É—Ç—Ä–∏ –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—Å—Å–∏–≤  –±–∞–∫–µ—Ç–æ–≤, –≥–¥–µ –∫–∞–∂–¥—ã–π –±–∞–∫–µ—Ç –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ 8 –ø–∞—Ä üîë-üìä. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Ä—Ç–∞–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ üîç –∏—Å–∫–∞—Ç—å, ‚ûï –≤—Å—Ç–∞–≤–ª—è—Ç—å –∏ ‚ùå —É–¥–∞–ª—è—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à-–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞.

```go
package runtime

// –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è Go map.
type hmap struct {
    count     int             // —Å–∫–æ–ª—å–∫–æ –ø–∞—Ä `–∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ` –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ –∫–∞—Ä—Ç–µ.
    B         uint8           //–£–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞ –±–∞–∫–µ—Ç–æ–≤. log_2 –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ üóÑÔ∏è –±–∞–∫–µ—Ç–æ–≤
    buckets   unsafe.Pointer  // –ú–∞—Å—Å–∏–≤ –∏–∑ 2^B üóÑÔ∏è –±–∞–∫–µ—Ç–æ–≤
    oldbuckets unsafe.Pointer // –°—Ç–∞—Ä—ã–π –º–∞—Å—Å–∏–≤ –±–∞–∫–µ—Ç–æ–≤,	// –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏
	nevacuate uintptr         // –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —ç–≤–∞–∫—É–∞—Ü–∏–∏. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –±–∞–∫–µ—Ç–æ–≤ —É–∂–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ `oldbuckets` –≤ –Ω–æ–≤—ã–µ `buckets`
    extra *mapextra           // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –±–∞–∫–µ—Ç—ã
}
```

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ hmap –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–µ Go. –û–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (count), –º–∞—Å—Å–∏–≤ –±–∞–∫–µ—Ç–æ–≤ (buckets) –∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –±–∞–∫–µ—Ç—ã (extra).

–û–ø–µ—Ä–∞—Ü–∏–∏ map –∏–º–µ—é—Ç<span style="background:#fff88f"> –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å O(1)</span>. –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ [[–∫–æ–ª–ª–∏–∑–∏–π]] (–∫–ª—é—á–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–∏–Ω –±–∞–∫–µ—Ç), –ø–æ–∏—Å–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –±–∞–∫–µ—Ç–µ.


## –ë–∞–∫–µ—Ç—ã –∏ –ö–∞–∫ –û–Ω–∏ –†–∞–±–æ—Ç–∞—é—Ç

–ë–∞–∫–µ—Ç - —ç—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ **8 –ø–∞—Ä `–∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ`**

–ö–∞–∂–¥—ã–π –±–∞–∫–µ—Ç –≤ Go —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- **8 –∫–ª—é—á–µ–π**.
- **8 –∑–Ω–∞—á–µ–Ω–∏–π**.
- **–ú–∞—Å—Å–∏–≤ —Ö—ç—à–µ–π (–¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ –±–∞–∫–µ—Ç–∞).**


–ï—Å–ª–∏ –≤ –±–∞–∫–µ—Ç–µ —É–∂–µ **8 –ø–∞—Ä `–∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ`**, —Ç–æ –≤ Go —Å–æ–∑–¥–∞—ë—Ç—Å—è **"–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –±–∞–∫–µ—Ç"**. <span style="background:#fff88f">–ù–æ–≤—ã–π –±–∞–∫–µ—Ç —Å–≤—è–∑–∞–Ω —Å –æ—Å–Ω–æ–≤–Ω—ã–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞—Ç–µ–ª—å</span>
1. –≠–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∫–µ—Ç, –Ω–∞—á–∏–Ω–∞—é—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –±–∞–∫–µ—Ç—ã.
2.  –ü—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–ª—é—á–∞ Go —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–∞–∫–µ—Ç–µ. –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –±–∞–∫–µ—Ç–∞—Ö.

<span style="background:#fff88f">–ö–æ–≥–¥–∞ –≤ –∫–∞—Ä—Ç–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –±–∞–∫–µ—Ç—ã, —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span> –ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∫–µ—Ç –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –±–∞–∫–µ—Ç—ã, –í —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ (–ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–ª–ª–∏–∑–∏–π) –ø–æ–∏—Å–∫ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ª–∏–Ω–µ–π–Ω—ã–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —ç–ª–µ–º–µ–Ω—Ç–æ–≤.

## –≠–≤–∞–∫—É–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö (–†–µ—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

–ö–æ–≥–¥–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ (–æ–±—ã—á–Ω–æ –æ–∫–æ–ª–æ 80%), Go –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, –≤—ã–¥–µ–ª—è—è –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –±–∞–∫–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –≤–¥–≤–æ–µ –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ. –í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏–∑ —Å—Ç–∞—Ä—ã—Ö –±–∞–∫–µ—Ç–æ–≤ —ç–≤–∞–∫—É–∏—Ä—É—é—Ç—Å—è –≤ –Ω–æ–≤—ã–µ, —á—Ç–æ–±—ã —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –∏ —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–∫–µ—Ç–æ–≤ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è.

```go
func evacuate(t *maptype, h *hmap, oldbucket uintptr) {
    b := (*bmap)(add(h.oldbuckets, oldbucket*uintptr(t.BucketSize)))
    newbit := h.noldbuckets()
    if !evacuated(b) {
        var xy [2]evacDst
        x := &xy[0]
        x.b = (*bmap)(add(h.buckets, oldbucket*uintptr(t.BucketSize)))
        if !h.sameSizeGrow() {
            y := &xy[1]
            y.b = (*bmap)(add(h.buckets, (oldbucket+newbit)*uintptr(t.BucketSize)))
        }
        for ; b != nil; b = b.overflow(t) {
            for i := 0; i < abi.MapBucketCount; i++ {
                top := b.tophash[i]
                if isEmpty(top) {
                    continue
                }
                useY := uint8(0)
                if !h.sameSizeGrow() {
                    hash := t.Hasher(k, uintptr(h.hash0))
                    if hash&newbit != 0 {
                        useY = 1
                    }
                }
                dst := &xy[useY]
                // –≠–≤–∞–∫—É–∏—Ä—É–µ–º –≤ –Ω–æ–≤—ã–π üóÑÔ∏è –±–∞–∫–µ—Ç
            }
        }
    }
}
```
–§—É–Ω–∫—Ü–∏—è evacuate –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ üóÑÔ∏è –±–∞–∫–µ—Ç–∞ –≤ –Ω–æ–≤—ã–µ üóÑÔ∏è –±–∞–∫–µ—Ç—ã –≤–æ –≤—Ä–µ–º—è —Ä–µ—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ö–µ—à–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –ª–∏–±–æ –≤ —Ç–æ—Ç –∂–µ üóÑÔ∏è –±–∞–∫–µ—Ç, –ª–∏–±–æ –≤ –Ω–æ–≤—ã–π üóÑÔ∏è –±–∞–∫–µ—Ç –ø–æ—Å–ª–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è.
## –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –∫–∞—Ä—Ç–∞–º–∏?

**–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏:**
- –ï—Å–ª–∏ –≤—ã –∑–Ω–∞–µ—Ç–µ, —Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –≤ –∫–∞—Ä—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ
```go
m := make(map[int]string, 1000000) // –ó–∞—Ä–∞–Ω–µ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –º–µ—Å—Ç–æ –¥–ª—è 1 –º–∏–ª–ª–∏–æ–Ω–∞ –∑–∞–ø–∏—Å–µ–π
```
 **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∫–ª—é—á–µ–π:**
 - –ù–∞–ø—Ä–∏–º–µ—Ä, `int` —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –∏ –∑–∞–Ω–∏–º–∞–µ—Ç –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏, —á–µ–º —Å—Ç—Ä–æ–∫–∏
 **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
 - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ [[–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ]] pprof, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –∫–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–¥–µ.

–ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞¬†`make`¬†—Å–æ–∑–¥–∞—ë—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è:
- –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –º–∞—Å—Å–∏–≤ –±–∞–∫–µ—Ç–æ–≤
- –î–ª–∏–Ω—É (`len`)
- –Å–º–∫–æ—Å—Ç—å (`cap`), –∫–æ—Ç–æ—Ä–∞—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–∫–µ—Ç–æ–≤
**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–∞–ø—ã:**¬†–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —É–¥–≤–æ–µ–Ω–∏–µ –±–∞–∫–µ—Ç–æ–≤ —Å –ø–µ—Ä–µ—Å—á—ë—Ç–æ–º —Ö—ç—à–µ–π

## –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

