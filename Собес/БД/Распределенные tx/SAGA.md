Это набор локальных транзакций. Каждая локальная транзакция обновляет базу данных и публикует сообщение или событие, инициируя следующую локальную транзакцию (По сути это **синхронное** взаимодействие между БД)


**SAGA** - это паттерн, который используется для координации нескольких действий из разных сервисов, то есть когда нужно выполнить последовательность операций как одну транзакцию, но не в рамках одного сервиса, а распределенно

Вместо того чтобы пытаться выполнить все действия как одну большую транзакцию, **SAGA** делит её на маленькие шаги

---
*Зачем он нужен?*
Когда приложение разбито на несколько сервисов, выполнение одной общей транзакции становится сложным. Например, покупка товаров в интернет-магазине может включать **оплату**, **проверку наличия** и **доставку** — каждый шаг выполняется в своём сервисе. SAGA позволяет координировать эти действия и откатывать их, если что-то пойдет не так
- Нет блокировки всех ресурсов — каждый шаг работает независимо
- Можно откатить выполненные действия, если одна из операций не удалась
- Каждый сервис делает свою часть работы и умеет её отменить при необходимости

---
*Как работает SAGA?*
Каждый шаг выполняется как самостоятельная локальная транзакция. Если случается ошибка, выполняются действия, чтобы откатить уже сделанные шаги
**2** **подхода** к управлению SAGA:
- **[[Оркестрация]]** (Orchestration): Один сервис (оркестратор) **управляет всей последовательностью шагов**. Он запускает действия и, если возникает ошибка, запускает откат. Каждый сервис сообщает оркестратору о завершении своего шага
```
Шаг 1 -> Шаг 2 -> Шаг 3 (Ошибка!) -> Откат Шаг 2 -> Откат Шаг 1
```
- **[[Хореография]]** (Choreography): Каждый сервис **самостоятельно запускает следующий шаг** и компенсацию. Например, после успешного завершения одной операции сервис посылает событие, которое запускает следующий сервис
   Сервисы взаимодействуют **через брокер** сообщений (например, RabbitMQ, **Kafka**)
```
Сервис А завершил -> Событие -> Сервис B начал -> Сервис B завершил -> Событие и т.д.
```
---

*Недостатки и плюсы:*
- Помогает управлять операциями между несколькими сервисами.
- Каждый сервис управляет своей логикой, что делает систему устойчивее к сбоям.

- Трудно разработать логику для отмены (компенсирующих действий)
---
*Пример*
У нас есть системы бронирований, где каждое действие выполняется в отдельном сервисе
1. **Резервирование авиабилетов** (Сервис А).
2. **Бронирование отеля** (Сервис B).
3. **Аренда автомобиля** (Сервис C).
Если бронь отеля не удалась, нужно отменить авиабилеты и аренду автомобиля. SAGA управляет каждым шагом как отдельной транзакцией, и если что-то не получилось, сервисы откатывают свои изменения (например, отменяют бронирование).

---

**Паттерн SAGA** — это простой способ координировать действия в распределённых системах, чтобы поддерживать **согласованность данных**. Он помогает разбить большую транзакцию на отдельные шаги и откатывать их, если что-то пошло не так. Главное — продумать, как откатить изменения в случае ошибки, чтобы не оставлять данные в некорректном состоянии.

Если один из шагов завершается с ошибкой (например, товара нет в наличии), нужно откатить предыдущие шаги, чтобы сохранить **согласованность** **данных**.

![[{39E63EAD-C138-4034-B9C9-73E60E923170}.png]]


![[{FB13A605-C76C-4B37-99A3-590C5309F203}.png]]
